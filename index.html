<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Single Trial Demo (Discrete 0–4)</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <style>
    .jspsych-content-wrapper { display:flex; justify-content:center; }
    .jspsych-content { max-width: 960px !important; margin: 40px auto !important; }
    body { font-family: system-ui, sans-serif; background:#fafafa; }
    .center { text-align:center; }
    video { display:block; margin: 0 auto; border-radius: 10px; background:#000; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
    .cell { text-align:center; }
    .tag { font-weight:700; margin:4px 0 8px; }
  </style>
</head>
<body></body>

<script type="module">
  window.onerror = (m, s, l, c, e) => {
    document.body.innerHTML = "<pre>"+m+"\n"+(e && e.stack || "")+"</pre>";
  };

  import { initJsPsych } from "https://esm.sh/jspsych";
  import jsPsychHtmlSliderResponse from "https://esm.sh/@jspsych/plugin-html-slider-response";
  import jsPsychHtmlButtonResponse from "https://esm.sh/@jspsych/plugin-html-button-response";

  const T = {
    scene: "car",
    direction: "LtoR",
    moa: "3s",
    stimulus: "videos/car_LtoR_3s.mp4"
  };

  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.get().localSave('csv','single_trial_demo.csv')
  });

  function viewClip(t){
    const html = `
      <div class="center">
        <p><em>Click Play to watch the clip.</em></p>
        <video id="mainvid" width="900" controls playsinline>
          <source src="${t.stimulus}" type="video/mp4">
        </video>
      </div>
    `;
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: html,
      choices: ['Continue →'],
      data: { phase:"view", ...t }
    };
  }

  // Preference slider: discrete 0–4, labels only at 0,2,4
  function prefSlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<div class="center"><p><strong>How much did you like the clip you just watched?</strong></p></div>',
      min: 0, max: 4, step: 1, slider_start: 2,
      labels: ['0 (not at all)', '', '2 (neutral)', '', '4 (very much)'],
      require_movement: true,
      data: { phase:"preference", ...t }
    };
  }

  // Simultaneity slider: discrete 0–4 with full wording
  function simultaneitySlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<div class="center"><p><strong>To what extent did the visual and auditory motion begin at the same time?</strong></p><p>(0 = very far apart, 2 = somewhat apart, 4 = exactly the same time)</p></div>',
      min: 0, max: 4, step: 1, slider_start: 2,
      labels: ['0 (very far apart)', '', '2 (somewhat apart)', '', '4 (exactly the same time)'],
      require_movement: true,
      data: { phase:"simultaneity_slider", ...t }
    };
  }

  function slowFilePath(src){
    const dot = src.lastIndexOf('.');
    return dot === -1 ? src + "_slow" : src.slice(0, dot) + "_slow" + src.slice(dot);
  }

  function lockRate(video, rate){
    const apply = () => {
      video.defaultPlaybackRate = rate;
      video.playbackRate = rate;
    };
    apply();
    const end = performance.now() + 2000;
    (function tick(){
      apply();
      if (performance.now() < end) requestAnimationFrame(tick);
    })();
    const reapply = () => apply();
    video.addEventListener('play', reapply);
    video.addEventListener('ratechange', reapply);
    video.addEventListener('seeking', reapply);
    video.addEventListener('loadeddata', reapply);
    video.addEventListener('ended', reapply);
  }

  function memoryTrial(t){
    const flip = t.direction === "LtoR" ? "RtoL" : "LtoR";
    const correct   = { src:`videos/${t.scene}_${t.direction}_${t.moa}.mp4`, rate:1.0, tag:'correct' };
    const wrongDir  = { src:`videos/${t.scene}_${flip}_${t.moa}.mp4`,        rate:1.0, tag:'wrong_dir' };
    const wrongSpd  = { src: correct.src,                                    rate:0.7, tag:'wrong_speed' };
    const bothWrong = { src: wrongDir.src,                                   rate:0.7, tag:'both_wrong' };

    const opts = jsPsych.randomization.shuffle([correct, wrongDir, wrongSpd, bothWrong]);
    const correct_index = opts.findIndex(o => o.tag === 'correct');
    const letters = ['A','B','C','D'];

    const gridHTML = `
      <div class="grid">
        ${opts.map((o,i)=>`
          <div class="cell">
            <div class="tag">${letters[i]}</div>
            <video id="opt${i}" muted loop playsinline width="420" preload="auto">
              <source id="src${i}" src="${o.rate===0.7 ? slowFilePath(o.src) : o.src}" type="video/mp4">
            </video>
          </div>
        `).join('')}
      </div>
      <div class="center"><p><em>Which clip matches the one you just watched (same direction & speed)?</em></p></div>
    `;

    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: gridHTML,
      choices: letters,
      on_load: () => {
        opts.forEach((o,i)=>{
          const v = document.getElementById(`opt${i}`);
          const s = document.getElementById(`src${i}`);
          v.muted = true; v.playsInline = true;

          if (o.rate === 0.7) {
            v.addEventListener('error', () => {
              s.src = o.src; v.load();
            }, { once:true });
            v.addEventListener('loadedmetadata', () => {
              const isSlowFile = s.src.includes("_slow");
              if (!isSlowFile) lockRate(v, 0.7);
              v.play().catch(()=>{});
            }, { once:true });
          } else {
            v.addEventListener('loadedmetadata', () => {
              v.defaultPlaybackRate = 1.0; v.playbackRate = 1.0;
              v.play().catch(()=>{});
            }, { once:true });
          }
          v.load();
        });
      },
      data: {
        phase:"memory",
        ...t,
        memory_option_order: opts.map(o=>o.tag).join(','),
        correct_index
      },
      on_finish: d => {
        d.choice_index = d.response;
        d.is_correct   = (d.response === correct_index);
      }
    };
  }

  const timeline = [
    viewClip(T),
    prefSlider(T),
    simultaneitySlider(T),
    memoryTrial(T),
    { type: jsPsychHtmlButtonResponse, stimulus: '<div class="center"><p>Thanks! Data saved.</p></div>', choices: ['Finish'] }
  ];

  jsPsych.run(timeline);
</script>
</html>

