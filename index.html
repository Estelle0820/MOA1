<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MOA1</title>

  <!-- jsPsych core + UMD plugins -->
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>

  <style>
    .jspsych-content-wrapper { display:flex; justify-content:center; }
    .jspsych-content { max-width:960px !important; margin:40px auto !important; }
    body { font-family: system-ui, sans-serif; background:#fafafa; }
    .center { text-align:center; }
    video { display:block; margin:0 auto; border-radius:10px; background:#000; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
    .cell { text-align:center; }
    .tag { font-weight:700; margin:6px 0 8px; }

    /* Bullets left-aligned inside centered sections */
    .center ul { list-style: disc outside; padding-left: 1.25em; margin: 0 auto; max-width: 720px; }
    .center li { text-align: left; }

    /* Slider labels */
    .jspsych-slider-container .jspsych-slider-labels{
      display:flex !important; justify-content:space-between !important; gap:0 !important;
      margin-top:10px !important; font-size:14px !important; line-height:1.2 !important;
    }
    .jspsych-slider-container .jspsych-slider-label{ text-align:center !important; flex:0 0 auto !important; }

    /* Hide seek bar + times */
    video::-webkit-media-controls-timeline,
    video::-webkit-media-controls-current-time-display,
    video::-webkit-media-controls-time-remaining-display { display:none !important; }
    video::-moz-media-controls-seekbar{ display:none !important; }
  </style>
</head>
<body></body>

<script>
  // Show errors on the page while testing
  window.onerror = (m, s, l, c, e) => {
    document.body.innerHTML = "<pre style='white-space:pre-wrap'>" + m + "\n" + (e && e.stack || "") + "</pre>";
  };

  // --------- helpers ----------
  function getParam(name){
    const m = new URLSearchParams(location.search).get(name);
    return m ? decodeURIComponent(m) : "";
  }

  // Google Sheets web app
  const GS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwREc6pHuKPKOOf-rqucyfdvnrqLyLgd7Al-g4kT6rX3KlFDC8V8b6t8vSqP0_JkaTsWA/exec";

  const jsPsych = initJsPsych({
    on_finish: async () => {
      const payload = {
        timestamp: new Date().toISOString(),
        participant: getParam('pid') || '',
        data: jsPsych.data.get().values()
      };
      try {
        await fetch(GS_WEBAPP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true
        });
        alert('Thanks! Your data was uploaded to Google Sheets.');
      } catch (e) {
        console.error(e);
        jsPsych.data.get().localSave('csv','moa1_fallback.csv');
        alert('Upload failed — CSV downloaded locally instead.');
      }
    }
  });

  // ----- UI pieces -----
  function lockRate(video, rate){
    const apply = () => { video.defaultPlaybackRate = rate; video.playbackRate = rate; };
    const end = performance.now() + 2000;
    (function tick(){ apply(); if (performance.now() < end) requestAnimationFrame(tick); })();
    ['play','ratechange','seeking','loadeddata','ended'].forEach(ev => video.addEventListener(ev, apply));
  }

  function viewClip(t){
    const html = `
      <div class="center">
        <p id="watchmsg"><em>Click Play to watch the clip. Continue will appear after it ends.</em></p>
        <video id="mainvid" width="900" controls playsinline preload="metadata"
               controlslist="nodownload noplaybackrate noremoteplayback">
          <source src="${t.stimulus}" type="video/mp4">
        </video>
        <div id="btnbox"></div>
      </div>`;
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: html,
      choices: [],
      data: { phase:"view", ...t },
      on_load: () => {
        const v = document.getElementById('mainvid');
        const box = document.getElementById('btnbox');
        const msg = document.getElementById('watchmsg');
        let revealed = false;

        const showContinue = () => {
          if (revealed) return; revealed = true;
          msg.textContent = 'You can continue.';
          const btn = document.createElement('button');
          btn.className = 'jspsych-btn';
          btn.textContent = 'Continue →';
          btn.onclick = () => jsPsych.finishTrial({ phase:"view", ...t });
          box.appendChild(btn);
        };

        const firstPlay = () => {
          v.removeAttribute('controls');
          v.addEventListener('pause', ()=>{ if(!v.ended) v.play().catch(()=>{}); });
          v.removeEventListener('play', firstPlay);
        };
        v.addEventListener('play', firstPlay);

        lockRate(v, 1.0);
        v.addEventListener('ended', showContinue, { once:true });
        v.addEventListener('contextmenu', e => e.preventDefault());
      }
    };
  }

  function prefSlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<div class="center"><p><strong>How much did you like the clip you just watched?</strong></p></div>',
      min:0, max:4, step:1, slider_start:2, slider_width:700,
      labels:['0 (Not at all)','1','2 (Neutral)','3','4 (Very much)'],
      require_movement:true,
      data:{ phase:"preference", ...t }
    };
  }

  function simultaneitySlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<div class="center"><p><strong>To what extent did the visual and auditory motion begin at the same time?</strong></p></div>',
      min:0, max:4, step:1, slider_start:2, slider_width:700,
      labels:['0 (Very far apart)','1','2 (Somewhat apart)','3','4 (Exactly the same time)'],
      require_movement:true,
      data:{ phase:"simultaneity_slider", ...t }
    };
  }

  function memoryTrial(t){
    const flip = t.direction === "LtoR" ? "RtoL" : "LtoR";
    const correct   = { src:`videos/${t.scene}_${t.direction}_${t.moa}.mp4`, rate:1.0, tag:'correct' };
    const wrongDir  = { src:`videos/${t.scene}_${flip}_${t.moa}.mp4`,        rate:1.0, tag:'wrong_dir' };
    const wrongSpd  = { src: correct.src,                                    rate:0.7, tag:'wrong_speed' };
    const bothWrong = { src: wrongDir.src,                                   rate:0.7, tag:'both_wrong' };

    const opts = jsPsych.randomization.shuffle([correct, wrongDir, wrongSpd, bothWrong]);
    const correct_index = opts.findIndex(o => o.tag === 'correct');
    const letters = ['A','B','C','D'];

    const gridHTML = `
      <div class="grid">
        ${opts.map((o,i)=>`
          <div class="cell">
            <div class="tag">${letters[i]}</div>
            <video id="opt${i}" muted loop playsinline preload="auto" width="420">
              <source src="${o.src}" type="video/mp4">
            </video>
          </div>`).join('')}
      </div>
      <div class="center"><p><em>Which clip matches the one you just watched (same direction & speed)?</em></p></div>`;

    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: gridHTML,
      choices: letters,
      on_load: () => {
        opts.forEach((o,i)=>{
          const v = document.getElementById(`opt${i}`);
          v.muted = true; v.playsInline = true; v.load();
          const start = () => {
            if (o.rate !== 1.0) lockRate(v, o.rate); else v.playbackRate = 1.0;
            try { if (v.currentTime === 0) v.currentTime = 0.001; } catch(e){}
            v.play().catch(()=>{});
          };
          v.addEventListener('loadeddata', start, { once:true });
          v.addEventListener('canplay',     start, { once:true });
        });
      },
      data:{ phase:"memory", ...t, memory_option_order: opts.map(o=>o.tag).join(','), correct_index },
      on_finish: d => { d.choice_index = d.response; d.is_correct = (d.response === correct_index); }
    };
  }

  // ----- experiment constants -----
  const scenes     = ["car","dog","horse","penguin","plane","roomba"];
  const directions = ["LtoR","RtoL"];
  const moas       = ["0s","3s","7s"];

  // Practice filenames
  const practiceTrials = [
    { scene:"practice1", direction:"LtoR", moa:"demo", stimulus:"videos/practice1_LtoR_demo.mp4" },
    { scene:"practice2", direction:"RtoL", moa:"demo", stimulus:"videos/practice2_RtoL_demo.mp4" }
  ];

  function memoryTrialPractice(t){
    const p1 = "videos/practice1_LtoR_demo.mp4";
    const p2 = "videos/practice2_RtoL_demo.mp4";
    const partner = (t.scene === "practice1") ? p2 : p1;

    const correct   = { src:t.stimulus, rate:1.0, tag:'correct' };
    const wrongDir  = { src:partner,    rate:1.0, tag:'wrong_dir' };
    const wrongSpd  = { src:t.stimulus, rate:0.7, tag:'wrong_speed' };
    const bothWrong = { src:partner,    rate:0.7, tag:'both_wrong' };

    const opts = jsPsych.randomization.shuffle([correct, wrongDir, wrongSpd, bothWrong]);
    const letters = ['A','B','C','D'];

    const gridHTML = `
      <div class="grid">
        ${opts.map((o,i)=>`
          <div class="cell">
            <div class="tag">${letters[i]}</div>
            <video id="opt${i}" muted loop playsinline preload="auto" width="420">
              <source src="${o.src}" type="video/mp4">
            </video>
          </div>`).join('')}
      </div>
      <div class="center"><p><em>Which clip matches the one you just watched (same direction & speed)?</em></p></div>`;

    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: gridHTML,
      choices: letters,
      on_load: () => {
        opts.forEach((o,i)=>{
          const v = document.getElementById(`opt${i}`);
          v.muted = true; v.playsInline = true; v.load();
          const start = () => {
            v.defaultPlaybackRate = o.rate; v.playbackRate = o.rate;
            try { if (v.currentTime === 0) v.currentTime = 0.001; } catch(e){}
            v.play().catch(()=>{});
          };
          v.addEventListener('loadeddata', start, { once:true });
          v.addEventListener('canplay',     start, { once:true });
        });
      },
      data:{ phase:"memory_practice", ...t }
    };
  }

  /* ---------- INTRO: one function, three trials ---------- */
  function screenTrial(html, btn="Continue"){
    return { type: jsPsychHtmlButtonResponse, stimulus:`<div class="wrap">${html}</div>`, choices:[btn] };
  }

  const intro1 = screenTrial(`
    <div class="center">
      <h2>Welcome to the study!</h2>
      <p>You will watch <strong>36 short animated videos</strong> showing objects moving across the screen.</p>
      <p>The sound will also move between your left and right headphones with the object.</p>
      <p>Please make sure you are wearing <strong>headphones in a quiet environment</strong>.</p>
    </div>
  `, "Next");

  const intro2 = screenTrial(`
    <div class="center">
      <h3>What you'll do after each video</h3>
      <ul>
        <li><strong>Preference rating</strong> – “How much did you like the clip you just watched?”</li>
        <li><strong>Timing judgment</strong> – “To what extent did the visual and auditory motion begin at the same time?”<br>
          <small>This means: did the movement you <em>saw</em> and the movement you <em>heard</em> seem to start together, or did one begin slightly earlier?</small>
        </li>
        <li><strong>Memory test</strong> – Choose which of four options matches the clip you just watched. Options may differ in <em>direction</em> and/or <em>speed</em>.</li>
      </ul>
      <p>After all 36 trials, you’ll answer a few brief demographic questions.</p>
    </div>
  `, "Next");

  const intro3 = screenTrial(`
    <div class="center">
      <h3>Using the sliders</h3>
      <p>For the preference and timing ratings, you will use a slider from <strong>0 to 4</strong>.</p>
      <ul>
        <li>Move the slider to the number that best matches your judgment.</li>
        <li>To select <strong>2 (Neutral)</strong>, click directly on 2.</li>
      </ul>
    </div>
  `, "Begin practice");

  // Practice timeline
  const practiceTimeline = [];
  practiceTrials.forEach(T => {
    practiceTimeline.push(viewClip(T));
    practiceTimeline.push(prefSlider(T));
    practiceTimeline.push(simultaneitySlider(T));
    practiceTimeline.push(memoryTrialPractice(T));
  });
  const practiceCompleteScreen = screenTrial(`
    <div class="center">
      <h3>Practice complete!</h3>
      <p>The main experiment will now begin.</p>
    </div>`, "Start main task");

  // Build main trials (use 3 while testing)
  const allTrials = [];
  scenes.forEach(scene=>{
    directions.forEach(dir=>{
      moas.forEach(moa=>{
        allTrials.push({ scene, direction:dir, moa, stimulus:`videos/${scene}_${dir}_${moa}.mp4` });
      });
    });
  });

  function shuffleWithConstraint(trials){
    let shuffled = jsPsych.randomization.shuffle(trials);
    for (let tries=0; tries<1000; tries++){
      let ok = true;
      for (let i=1;i<shuffled.length;i++){
        if (shuffled[i-1].scene===shuffled[i].scene && shuffled[i-1].direction===shuffled[i].direction){ ok=false; break; }
      }
      if (ok) return shuffled;
      shuffled = jsPsych.randomization.shuffle(trials);
    }
    return shuffled;
  }
  const constrained = shuffleWithConstraint(allTrials).slice(0,3); // ← change to 18 later

  const mainTimeline = [];
  constrained.forEach(T => {
    mainTimeline.push(viewClip(T));
    mainTimeline.push(prefSlider(T));
    mainTimeline.push(simultaneitySlider(T));
    mainTimeline.push(memoryTrial(T));
  });

  // Demographics
  const demographics = {
    type: jsPsychSurveyText,
    preamble: `
      <div class="center">
        <h2>Screen 6</h2>
        <p>You have finished the <strong>36 animation trials</strong>. Last, please answer these demographic questions:</p>
      </div>
    `,
    questions: [
      {prompt: "1) Please enter your age.", name: "age", required: true, placeholder: "e.g., 26"},
      {prompt: "2) Please enter your gender.", name: "gender", required: true, placeholder: "e.g., woman / man / nonbinary / prefer to self-describe"},
      {prompt: "3) Please enter your race/ethnicity.", name: "race_ethnicity", required: true, placeholder: "e.g., Asian; White; Black; Hispanic/Latino; Multiracial; …"},
      {prompt: "4) Do you have normal hearing?", name: "hearing", required: true, placeholder: "e.g., Yes / No / Unsure"}
    ],
    button_label: "Continue",
    on_load: () => {
      const style = document.createElement('style');
      style.textContent = `
        .jspsych-survey-text .jspsych-survey-text-preamble { text-align: center; }
        .jspsych-survey-text-question      { text-align: left; max-width: 720px; margin: 0 auto 16px; }
        .jspsych-survey-text-question p    { margin-bottom: 6px; font-weight: 600; }
        .jspsych-survey-text-question input{ width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .jspsych-btn { padding: 10px 18px; border-radius: 8px; }
      `;
      document.head.appendChild(style);
    }
  };

  // Final / Debrief
  const final_debrief = {
    type: jsPsychHtmlButtonResponse,
    stimulus: `
      <div class="center" style="max-width: 820px; margin: 0 auto; line-height:1.5;">
        <h2>Thank you for participating in this study!</h2>
        <p>
          In this experiment, sometimes the visual and auditory motion of the object started at the same time,
          and sometimes the visual motion began slightly earlier. We are interested in whether you can perceive
          these differences, whether your liking of the clips varies depending on synchrony, and whether synchrony
          influences your memory for the speed and direction of the video clips.
        </p>
        <p>
          If you would like to discuss the study further or are curious about this research, please contact
          <strong>Estelle Song</strong> at <a href="mailto:ssong@albany.edu">ssong@albany.edu</a> or the faculty advisor,
          <strong>Dr. Ronald Friedman</strong> at <a href="mailto:rfriedman@albany.edu">rfriedman@albany.edu</a>.
          You may also contact either researcher if you would like your data withdrawn from the study. If you choose to do so,
          you will still receive full credit for participation and will not be penalized in any way.
        </p>
        <p>
          If you experienced any discomfort during this study, or wish to discuss any other concerns, you may contact the
          <strong>University Counseling Center</strong> at (518) 442-5800.
        </p>
        <p>
          Because this research is potentially important, we kindly ask that you please do not discuss the study with others
          before they participate. Prior knowledge could affect their natural responses.
        </p>
        <p>Thank you very much for your assistance with this project!</p>
      </div>
    `,
    choices: ["Finish"]
  };

  // Run
  jsPsych.run([
    intro1,
    intro2,
    intro3,
    ...practiceTimeline,
    practiceCompleteScreen,
    ...mainTimeline,
    demographics,
    final_debrief
  ]);
</script>
</html>
