<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>jsPsych minimal split-pages</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.0.0"></script>
  <style>
    .jspsych-content { max-width: 900px !important; margin: 40px auto !important; }
    .center { text-align:center; }
    .center ul { list-style: disc; text-align:left; margin: 0 auto; max-width: 720px; }
  </style>
</head>
<body></body>

<script>
  // visible errors
  window.onerror = (m, s, l, c, e) => {
    document.body.innerHTML = "<pre>" + m + "\n" + (e && e.stack || "") + "</pre>";
  };

  const jsPsych = initJsPsych();

  // helper: one-page trial with a button
  function screenTrial(html, btn="Continue"){
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: `<div class="wrap">${html}</div>`,
      choices: [btn],
      on_start: () => {
        const p = jsPsych.getProgress();
        console.log(`[INTRO] start; current=${p.current_trial_global}, total=${p.total_trials}`);
      }
    };
  }

  // --- 3 separate intro pages ---
  const intro1 = screenTrial(`
    <div class="center">
      <h2>Welcome</h2>
      <p>Page 1 of intro.</p>
    </div>
  `, "Next");

  const intro2 = screenTrial(`
    <div class="center">
      <h3>What you'll do</h3>
      <ul>
        <li>Preference rating</li>
        <li>Timing judgment</li>
        <li>Memory test</li>
      </ul>
      <p>Page 2 of intro.</p>
    </div>
  `, "Next");

  const intro3 = screenTrial(`
    <div class="center">
      <h3>Using the sliders</h3>
      <ul>
        <li>0–4 scale</li>
        <li>Click 2 for neutral</li>
      </ul>
      <p>Page 3 of intro.</p>
    </div>
  `, "Begin practice");

  // --- One practice video page (button-response with manual continue) ---
  function lockRate(video, rate){
    const apply = () => { video.defaultPlaybackRate = rate; video.playbackRate = rate; };
    const end = performance.now() + 1500;
    (function tick(){ apply(); if (performance.now() < end) requestAnimationFrame(tick); })();
    ['play','ratechange','seeking','loadeddata','ended'].forEach(ev => video.addEventListener(ev, apply));
  }

  function viewClip(t){
    const html = `
      <div class="center">
        <p id="watchmsg"><em>Click Play. Continue appears after it ends.</em></p>
        <video id="mainvid" width="720" controls playsinline preload="metadata" controlslist="nodownload noplaybackrate noremoteplayback">
          <source src="${t.src}" type="video/mp4">
        </video>
        <div id="btnbox"></div>
      </div>`;
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: html,
      choices: [], // no built-in button; we show it after video ends
      data: { phase:"practice_view" },
      on_start: () => {
        const p = jsPsych.getProgress();
        console.log(`[PRACTICE VIEW] start; current=${p.current_trial_global}, total=${p.total_trials}`);
      },
      on_load: () => {
        const v = document.getElementById('mainvid');
        const box = document.getElementById('btnbox');
        const msg = document.getElementById('watchmsg');
        let revealed = false;

        const showContinue = () => {
          if (revealed) return; revealed = true;
          msg.textContent = 'You can continue.';
          const btn = document.createElement('button');
          btn.className = 'jspsych-btn';
          btn.textContent = 'Continue →';
          btn.onclick = () => jsPsych.finishTrial();
          box.appendChild(btn);
        };

        const firstPlay = () => {
          v.removeAttribute('controls');
          v.addEventListener('pause', ()=>{ if(!v.ended) v.play().catch(()=>{}); });
          v.removeEventListener('play', firstPlay);
        };
        v.addEventListener('play', firstPlay);

        lockRate(v, 1.0);
        v.addEventListener('ended', showContinue, { once:true });
      }
    };
  }

  // --- a slider page to prove separation ---
  function prefSlider(){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<div class="center"><p><strong>How much did you like the clip?</strong></p></div>',
      min:0, max:4, step:1, slider_start:2, slider_width:600,
      labels:['0','1','2','3','4'],
      require_movement:true,
      data:{ phase:"preference" },
      on_start: () => {
        const p = jsPsych.getProgress();
        console.log(`[SLIDER] start; current=${p.current_trial_global}, total=${p.total_trials}`);
      }
    };
  }

  // --- RUN ---
  jsPsych.run([
    intro1,       // page 1
    intro2,       // page 2
    intro3,       // page 3
    viewClip({src: "videos/practice1_LtoR_demo.mp4"}), // page 4
    prefSlider()  // page 5
  ]);
</script>
</html>
