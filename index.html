<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MOA Study</title>
  <!-- Only the CSS in <head>; no script tags here -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jspsych@7.3.4/css/jspsych.css" />
  <style>body{max-width:900px;margin:40px auto;font-family:sans-serif}</style>
</head>
<body></body>

<!-- Everything loads via ES modules -->
<script type="module">
  // Show any error on-screen so the page never looks blank
  window.onerror = (m, s, l, c, e) => { document.body.innerHTML = "<pre>"+m+"\n"+(e&&e.stack||"")+"</pre>"; };

  // Import jsPsych core + plugins (module builds)
  import { initJsPsych } from "https://cdn.jsdelivr.net/npm/jspsych@7.3.4/dist/index.js";
  import jsPsychPreload from "https://cdn.jsdelivr.net/npm/@jspsych/plugin-preload@1.1.3/dist/index.js";
  import jsPsychInstructions from "https://cdn.jsdelivr.net/npm/@jspsych/plugin-instructions@1.1.4/dist/index.js";
  import jsPsychVideoKeyboardResponse from "https://cdn.jsdelivr.net/npm/@jspsych/plugin-video-keyboard-response@1.1.4/dist/index.js";
  import jsPsychSurveyLikert from "https://cdn.jsdelivr.net/npm/@jspsych/plugin-survey-likert@1.2.1/dist/index.js";

  const scenes = ["car","dog","horse","penguin","plane","roomba"];
  const dirs   = ["LtoR","RtoL"];
  const moas   = ["0s","3s","7s"];

  function makeTrials(){
    const t=[];
    for(const s of scenes) for(const d of dirs) for(const m of moas){
      t.push({scene:s, direction:d, moa:m, stimulus:`videos/${s}_${d}_${m}.mp4`});
    }
    return t;
  }

  function shuffleWithConstraint(items){
    const n=items.length, used=new Array(n).fill(false), order=[];
    const conflict=Array.from({length:n},()=>Array(n).fill(false));
    for(let i=0;i<n;i++) for(let j=0;j<n;j++) if(i!==j)
      conflict[i][j]=(items[i].scene===items[j].scene)&&(items[i].direction===items[j].direction);
    const idx=[...Array(n).keys()];
    function sh(a){for(let i=a.length-1;i>0;i--){const k=Math.floor(Math.random()*(i+1));[a[i],a[k]]=[a[k],a[i]]}return a}
    function bt(pos){ if(pos===n) return true; sh(idx);
      for(const i of idx){ if(used[i]) continue; if(pos>0 && conflict[order[pos-1]][i]) continue;
        used[i]=true; order.push(i); if(bt(pos+1)) return true; order.pop(); used[i]=false; }
      return false;
    }
    if(!bt(0)) throw new Error("ordering failed");
    return order.map(i=>items[i]);
  }

  const TRIALS = shuffleWithConstraint(makeTrials());

  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.get().localSave('csv','moa_study_data.csv')
  });

  const preload = {
    type: jsPsychPreload,
    auto_preload: false,
    video: TRIALS.map(t=>t.stimulus),
    message: '<p><strong>Loading videosâ€¦</strong></p><p>This may take a minute on first load.</p>',
    continue_after_error: true,
    show_progress_bar: true
  };

  const intro = {
    type: jsPsychInstructions,
    pages: [
      `<p><strong>Welcome!</strong></p>
       <p>You will watch 36 short clips with sound.</p>
       <p>Wear headphones. After each clip, rate how much you liked it.</p>
       <p>Click Next to begin.</p>`
    ],
    show_clickable_nav: true
  };

  function viewClip(t){ return {
    type: jsPsychVideoKeyboardResponse,
    stimulus: [t.stimulus],
    choices: "NO_KEYS",
    trial_ends_after_video: true,
    width: 800,
    data: {phase:"view", ...t}
  };}

  function rateLiking(t){ return {
    type: jsPsychSurveyLikert,
    questions: [{prompt:"How much did you like that clip?", labels:["1","2","3","4","5","6","7"], required:true}],
    data: {phase:"liking", ...t}
  };}

  const block = TRIALS.flatMap(t => [viewClip(t), rateLiking(t)]);
  jsPsych.run([preload, intro, ...block]);
</script>
</html>
