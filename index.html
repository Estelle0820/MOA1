<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Single Trial Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" />
  <style>
    body { max-width: 960px; margin: 40px auto; font-family: system-ui, sans-serif; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
    .cell { text-align: center; }
    .cell .tag { font-weight: 700; margin: 4px 0 8px; }
    video { width: 100%; max-width: 420px; background:#000; border-radius: 10px; }
  </style>
</head>
<body></body>

<script type="module">
  // show any error on screen so it's never blank
  window.onerror = (m, s, l, c, e) =>
    { document.body.innerHTML = "<pre>"+m+"\n"+(e&&e.stack||"")+"</pre>"; };

  // Use esm.sh (reliable ESM) and HTML-based plugins
  import { initJsPsych } from "https://esm.sh/jspsych";
  import jsPsychHtmlSliderResponse from "https://esm.sh/@jspsych/plugin-html-slider-response";
  import jsPsychHtmlButtonResponse from "https://esm.sh/@jspsych/plugin-html-button-response";

  // ----- ONE stimulus -----
  const trialInfo = {
    scene: "car",
    direction: "LtoR",
    moa: "3s",
    stimulus: "videos/car_LtoR_3s.mp4"   // ← change if your filename differs
  };

  const jsPsych = initJsPsych({
    on_finish: () => jsPsych.data.get().localSave('csv','single_trial_demo.csv')
  });

  // 1) Watch the clip (click Play; Continue enables after video ends)
  function viewClip(t){
    const html = `
      <p><em>Click Play to watch the clip.</em></p>
      <video id="mainvid" width="900" controls playsinline>
        <source src="${t.stimulus}" type="video/mp4">
      </video>
    `;
    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: html,
      choices: ['Continue'],
      button_html: '<button id="contbtn" class="jspsych-btn" disabled>%choice%</button>',
      on_load: () => {
        const v = document.getElementById('mainvid');
        const b = document.getElementById('contbtn');
        v.addEventListener('ended', () => { b.disabled = false; });
      },
      data: { phase: "view", ...t }
    };
  }

  // 2a) Slider: Preference 0–4 (continuous)
  function prefSlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<p><strong>How much did you like the clip you just watched?</strong></p>',
      min: 0, max: 4, step: 0.01, slider_start: 2,
      labels: ['0 (not at all)','4 (very much)'],
      require_movement: true,
      data: { phase: "preference", ...t }
    };
  }

  // 2b) Slider: Perceived simultaneity 0–4 (continuous)
  function simultaneitySlider(t){
    return {
      type: jsPsychHtmlSliderResponse,
      stimulus: '<p><strong>How together were the visual & auditory onsets?</strong></p>',
      min: 0, max: 4, step: 0.01, slider_start: 2,
      labels: ['0 (not at all together)','4 (exactly together)'],
      require_movement: true,
      data: { phase: "simultaneity_slider", ...t }
    };
  }

  // 3) Memory: 4 choices (correct / wrong-dir / wrong-speed 0.7× / both wrong)
  function memoryTrial(t){
    const flipped   = t.direction === "LtoR" ? "RtoL" : "LtoR";
    const correct   = { src:`videos/${t.scene}_${t.direction}_${t.moa}.mp4`, rate:1.0, tag:'correct' };
    const wrongDir  = { src:`videos/${t.scene}_${flipped}_${t.moa}.mp4`,     rate:1.0, tag:'wrong_dir' };
    const wrongSpd  = { src: correct.src,                                    rate:0.7, tag:'wrong_speed' };
    const bothWrong = { src: wrongDir.src,                                   rate:0.7, tag:'both_wrong' };

    let opts = jsPsych.randomization.shuffle([correct, wrongDir, wrongSpd, bothWrong]);
    const correct_index = opts.findIndex(o => o.tag === 'correct');
    const letters = ['A','B','C','D'];

    const gridHTML = `
      <div class="grid">
        ${opts.map((o,i)=>`
          <div class="cell">
            <div class="tag">${letters[i]}</div>
            <video id="opt${i}" src="${o.src}" muted loop playsinline></video>
          </div>
        `).join('')}
      </div>
      <p><em>Which clip matches the one you just watched (same direction & speed)?</em></p>
    `;

    return {
      type: jsPsychHtmlButtonResponse,
      stimulus: gridHTML,
      choices: letters,
      on_load: () => {
        // muted autoplay allowed; set playbackRate for the speed foils
        opts.forEach((o,i)=>{
          const v = document.getElementById(`opt${i}`);
          v.playbackRate = o.rate;              // 1.0 or 0.7
          v.addEventListener('canplay', ()=> v.play(), { once:true });
          v.load();
        });
      },
      data: {
        phase:"memory",
        ...t,
        memory_option_order: opts.map(o=>o.tag).join(','),
        correct_index
      },
      on_finish: (d) => {
        d.choice_index = d.response;            // 0..3
        d.is_correct   = (d.response === correct_index);
      }
    };
  }

  // Build & run the one-trial timeline
  const timeline = [
    viewClip(trialInfo),
    prefSlider(trialInfo),
    simultaneitySlider(trialInfo),
    memoryTrial(trialInfo),
    { type: jsPsychHtmlButtonResponse, stimulus: "<p>Thanks! Data saved.</p>", choices:["Finish"] }
  ];

  jsPsych.run(timeline);
</script>
</html>
